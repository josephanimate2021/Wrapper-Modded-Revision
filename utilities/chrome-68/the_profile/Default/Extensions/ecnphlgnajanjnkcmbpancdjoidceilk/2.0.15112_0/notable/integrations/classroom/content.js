var injectButton=function(){const e=document.querySelector('[role="toolbar"]'),t="kami-drive-viewer-toolstrip-mid-panel";if(!Array.from(e.childNodes).find((e=>e.classList.contains(t)))){var n=document.createElement("div");n.classList.add(t),n.innerHTML='<div class="kami-drive-viewer-toolstrip-open-and-openwith"><a class="kami-drive-viewer-toolstrip-open" role="button" data-tooltip-unhoverable="true" data-tooltip-delay="500" data-tooltip-class="drive-viewer-jfk-tooltip" data-tooltip-align="b,c" data-tooltip-offset="-6" aria-hidden="false" aria-label="Open with Kami" style="user-select: none;" tabindex="0" data-tooltip="Open with Kami"><div class="kami-drive-viewer-open-app-icon"></div><div class="kami-drive-viewer-open-label">Open with Kami</div></a></div>',driveRightButtonsContainerLeftPosition=document.body.offsetWidth-document.querySelector(".ndfHFb-c4YZDc-Wrql6b-AeOLfc-b0t70b").getBoundingClientRect().left,n.style.margin=`4px ${driveRightButtonsContainerLeftPosition}px 0px auto`,e.children[0].appendChild(n),document.querySelector(".kami-drive-viewer-toolstrip-open").addEventListener("click",(function(e){wrapWindowOpen();var t=document.querySelector(".ndfHFb-c4YZDc-z5C9Gb-LgbsSe"),n=document.createEvent("MouseEvents");n.initEvent("mousedown",!0,!0),t.dispatchEvent(n);const o=document.querySelector(".ndfHFb-c4YZDc-xl07Ob.ndfHFb-c4YZDc-xl07Ob-BvBYQ.ndfHFb-c4YZDc-s2gQvd.ndfHFb-c4YZDc-i5oIFb.ndfHFb-c4YZDc-z5C9Gb-xl07Ob");o&&(o.style.visibility="hidden"),setTimeout((function(){var e=document.querySelector(".ndfHFb-c4YZDc-j7LFlb-Bz112c.ndfHFb-c4YZDc-GSQQnc-LgbsSe").parentElement,t=e.getBoundingClientRect(),n=new MouseEvent("mouseup",{view:window,bubbles:!0,cancelable:!0,clientX:t.left+5,clientY:t.top+5,x:t.left+5,y:t.top+5});e.dispatchEvent(n)}),10)}))}},injectAnnotateWithKamiInterceptor=function(){const e=document.querySelector(".ndfHFb-c4YZDc-Wrql6b-qMHh7d-SmKAyb");if(e){if(e.classList.contains("handler-added"))return;e.classList.add("handler-added"),e.addEventListener("click",(function(e){setTimeout((function(){const e=document.querySelectorAll(".ndfHFb-c4YZDc-j7LFlb-bN97Pc"),t=Array.from(e).find((e=>"Annotate with Kami"===e.textContent));t.classList.contains("intercepted")||(t.classList.add("intercepted"),t.addEventListener("mouseup",(function(e){e.stopImmediatePropagation(),e.preventDefault(),document.querySelector(".kami-drive-viewer-toolstrip-open").click()})))}),0)}))}};function googleStateFromOpenUrl(e,t){let n,o,i=new URL(e);if(i.searchParams.get("id")&&i.searchParams.get("id").match(/[A-z0-9-_]+/)&&(n=i.searchParams.get("id")),!n){const e=i.pathname.match(/\/d\/([A-z0-9-_]+)\/(view|edit)/);e&&(n=e[1])}if(!n)return;if(i.searchParams.get("authuser")&&i.searchParams.get("authuser").match(/\d+/)&&(o=i.searchParams.get("authuser")),!o){const e=window.location.href.match(/\/u\/(\d+)\//);e&&(o=e[1])}const a={ids:[n],from:t};o&&(a.authuser=o);const r=window.location.href.match(/\/c\/.*?\/a\/.*?\//);return r&&(a.courseworkAlternateLink=r[0]),a}var wrapWindowOpenScript=function(){/\{\s*\[native code\]\s*\}/.test(""+window.open)&&(window.originalOpen=window.open),window.open=function(){window.open=window.originalOpen;const e=googleStateFromOpenUrl(arguments[0],"classroomopenext");e?(kamiURL="https://web.kamihq.com"+"/web/viewer.html?state="+encodeURIComponent(JSON.stringify(e)),window.open(kamiURL,"_blank")):window.open.apply(this,arguments)};var e=document.currentScript;e&&null!==e.parentNode&&e.parentNode.removeChild(e)},wrapWindowOpen=function(){var e=document.head||document.documentElement;if(null===e)return!1;var t=document.createElement("script");t.textContent=googleStateFromOpenUrl.toString()+";("+wrapWindowOpenScript.toString()+")();";try{e.appendChild(t)}catch(e){}},previewOpenObserver=new MutationObserver((function(e){e.forEach((function(e){if(e.addedNodes)for(var t=0;t<e.addedNodes.length;t++){var n=e.addedNodes[t];n.attributes&&n.attributes["aria-label"]&&n.attributes.role&&"dialog"===n.attributes.role.value&&(injectButton(),injectAnnotateWithKamiInterceptor(),previewOpenObserver.disconnect())}}))})),fetchClassroomAlternateId=function(){var e=window.location.href.match(/https?:\/\/classroom\.google\.com.*\/[cw]\/([A-z0-9]+)/);return e&&e.length>1?e[1]:null},kamiCreateAssignmentButtonListener=function(e){console.log(e),document.body.click(),window.scroll(0,0),kamiURL=`${"https://web.kamihq.com"}/web/viewer.html?open_dialog=create_assignment&seamless_dialog=true&parent_origin=${encodeURIComponent(window.location.origin)}`;var t=fetchClassroomAlternateId();t&&(kamiURL+="&class_alternate_id="+t);var n=`<iframe src="${kamiURL}" seamless="" class="kami-create-assignment-iframe"></iframe>`;const o=document.createElement("div");o.innerHTML=n;var i=o.children[0];o.removeChild(i);o.innerHTML='<div class="kami-create-assignment-loader"><div class="lds-dual-ring"></div></div>';var a=o.children[0];o.removeChild(a);var r=e=>{if(e.data&&"kami"===e.data.type&&("assignment_dialog_opened"===e.data.event&&document.body.removeChild(a),"assignment_dialog_closed"===e.data.event)){window.removeEventListener("message",r),document.body.style.overflow=null,document.body.removeChild(i);var t=document.body.querySelector(".kami-create-assignment-loader");t&&t.remove()}};window.addEventListener("message",r),document.body.style.overflow="hidden",document.body.appendChild(i),document.body.appendChild(a)},createButtonObserver=new MutationObserver((function(e){e.forEach((function(e){if(e.addedNodes)for(var t=0;t<e.addedNodes.length;t++){var n=e.addedNodes[t];n&&n.classList&&n.classList.contains("Y5vSD")&&n.classList.contains("SRX5Hd")&&injectClassroomKamiAssignmentButton()}}))})),injectClassroomKamiAssignmentButton=function(){let e=document.querySelectorAll('.Y5vSD.SRX5Hd li[role="menuitem"]');e.length>0?e.forEach((function(e){if(!e.parentElement.parentElement.querySelector(".kami-create-assignment-button")){kami_button_html='<li class="VfPpkd-StrnGf-rymPhb-ibnC6b kami-create-assignment-button" role="menuitem" tabindex="-1" jsaction="mouseenter:SKyDAe; mouseleave:xq3APb;" jsname="j7LFlb">\n          <span class="VfPpkd-StrnGf-rymPhb-pZXsl"></span>\n          <span class=" VfPpkd-StrnGf-rymPhb-f7MjDc">\n            <span class="kami-create-assignment-new-icon" aria-hidden="true"></span>\n          </span>\n          <span class="VfPpkd-StrnGf-rymPhb-b9t22c">\n              Kami assignment                \n          </span>\n          </li>';const t=htmlStringToElement(kami_button_html),n=e.closest("ul").querySelectorAll("li")[1];e.parentElement.insertBefore(t,n),t.addEventListener("click",kamiCreateAssignmentButtonListener)}})):createButtonObserver.observe(document.body,{childList:!0,subtree:!0,attributes:!1,characterData:!1})};function htmlStringToElement(e){const t=document.createElement("div");if(t.innerHTML=e,1!==t.children.length)throw new Error("htmlStringToElement must have exactly 1 root element");const n=t.children[0];return t.removeChild(n),n}injectClassroomKamiAssignmentButton(),document.body.addEventListener("click",(function(e){var t=e.target.closest("a");if(t){var n=t.href;n&&(n.includes("https://drive.google.com/open")||n.includes("https://drive.google.com/file/d/")||n.includes("https://drive.google.com/document/d/"))&&(document.querySelector(".kami-drive-viewer-toolstrip-mid-panel")||previewOpenObserver.observe(document.body,{childList:!0,subtree:!0,attributes:!1,characterData:!1})),n&&n.match(/https?:\/\/classroom\.google\.com.*\/c\/[A-z0-9]+/)&&setTimeout((function(){injectClassroomKamiAssignmentButton()}),150)}}));